name: 'Tests Python package'
description: 'Tests a Python package against the test suite'
inputs:
  artifact-name:
    default: "artifact"
  artifact-path:
    default: "dist"
  python-version:
    required: true
runs:
  using: 'composite'
  steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Download distribution artifact
      uses: actions/download-artifact@v2
      with:
        name: ${{ inputs.artifact-name }}
        path: ${{ inputs.artifact-path }}

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: ${{ inputs.python-version }}

    - name: Install poetry and add plugins
      run: |
        curl -sSL https://install.python-poetry.org | python3 -
        echo "PATH=$HOME/.poetry/bin:$PATH" >> $GITHUB_ENV
        poetry self update --preview
        poetry self add poetry-plugin-export
      shell: bash

    - name: Install dev dependencies
      run: |
        poetry export --without-hashes -f requirements.txt --output requirements-dev.txt --only dev
        pip install -r requirements-dev.txt
      shell: bash

    - name: Test package
      run: |
        PACKAGE_NAME=`(cd dist && ls *whl | cut -f 1 -d "-")` && echo $PACKAGE_NAME
        pip install --pre --find-links ./dist/ $PACKAGE_NAME
        cd tests && python run_tests.py
      shell: bash
